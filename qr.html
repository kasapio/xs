<!DOCTYPE html>
<html lang="pl">
<head>
    <title>mObywatel</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/qr.css">
    <link rel="stylesheet" href="assets/main.css">
    <link rel="icon" type="image/x-icon" href="images/otM5jOA.png">
    <link rel="apple-touch-icon" href="images/otM5jOA.png">
    <link rel="shortcut icon" href="images/otM5jOA.png">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* Dodatkowe style dla modala kodu QR */
        #qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }
        
        .modal-header {
            display: flex;
            justify-content: flex-end;
            padding: 15px 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 16px;
            color: #333;
            cursor: pointer;
        }
        
        .modal-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        
        .qr-code-container {
            width: 300px;
            height: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .qr-number {
            font-size: 48px;
            font-weight: bold;
            letter-spacing: 8px;
            margin: 20px 0;
            color: #333;
        }
        
        .qr-timer {
            margin: 20px 0;
            font-size: 14px;
            color: #666;
        }
        
        .progress-bar {
            width: 300px;
            height: 4px;
            background: #f0f0f0;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #0066cc;
            width: 100%;
            transform-origin: left;
            transition: transform 1s linear;
        }
        
        .expired-message {
            color: #ff4444;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .regenerate-btn {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="error">
        <div class="opacity close"></div>
        <div class="error_box">
            <p class="error_title">Coś poszło nie tak...</p>
            <p class="error_description">Wygląda na to, że wystąpił bład, spróbuj ponownie później.</p>
            <p class="error_button close">Rozumiem</p>
        </div>
    </div>

    <div class="bottom_bar">
        <div class="bottom_bar_grid">
            <div class="bottom_element_grid" send="home">
                <div class="bottom_element_image home"></div>
                <p class="bottom_element_text">Pulpit</p>
            </div>
            <div class="bottom_element_grid" send="documents">
                <div class="bottom_element_image documents"></div>
                <p class="bottom_element_text">Dokumenty</p>
            </div>
            <div class="bottom_element_grid" send="services">
                <div class="bottom_element_image services"></div>
                <p class="bottom_element_text">Usługi</p>
            </div>
            <div class="bottom_element_grid" send="qr">
                <div class="bottom_element_image qr qr_open"></div>
                <p class="bottom_element_text open">Kod QR</p>
            </div>
            <div class="bottom_element_grid" send="more">
                <div class="bottom_element_image more"></div>
                <p class="bottom_element_text">Więcej</p>
            </div>
        </div>
    </div>

    <div class="container">
        <p class="main_title">Kod QR</p>
        <p class="description">Wybierz, co chcesz zrobić</p>
        <div class="action_grid">
            <div class="action">
                <img class="action_image" src="images/Pfan6Qa.png">
                <div class="action_text">
                    <p class="action_title">Zeskanuj kod QR</p>
                    <p class="action_subtitle">Zaloguj się lub potwierdź swoje dane.</p>
                </div>
                <img class="arrow" src="images/2aN0vJE.png">
            </div>
            <div class="action">
                <img class="action_image" src="images/YJpEaiC.png">
                <div class="action_text">
                    <p class="action_title">Pokaż kod QR</p>
                    <p class="action_subtitle">Sprawdź dokument innej osoby.</p>
                </div>
                <img class="arrow" src="images/2aN0vJE.png">
            </div>
        </div>
    </div>

    <script src="assets/bar.js?v=2.0"></script>
    <script>
        var error = document.querySelector(".error");

        document.querySelectorAll(".action").forEach((element, index) => {
            element.addEventListener('click', () => {
                if (index === 0) {
                    var params = new URLSearchParams(window.location.search);
                    window.location.href = "qr2.html?" + params.toString();
                } 
                else if (index === 1) {
                    showQRCode();
                }
            });
        });

        document.querySelectorAll(".close").forEach((element) => {
            element.addEventListener('click', () => {
                error.classList.remove("error_open");
            })
        })

        function showQRCode() {
            // Za każdym razem generuj całkowicie nowe dane
            var firstName = generateRandomName();
            var lastName = generateRandomName();
            var numericCode = generateRandomCode();
            
            // Generuj losowy numer dokumentu
            var documentNumber = generateDocumentNumber();
            
            var qrData = `VERIFY|${firstName}|${lastName}|${documentNumber}|${numericCode}|${Date.now()}`;
            createQRModal(qrData, numericCode, firstName, lastName);
        }

        function generateRandomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        function generateRandomName() {
            const names = ['Anna', 'Jan', 'Maria', 'Piotr', 'Katarzyna', 'Andrzej', 'Malgorzata', 'Tomasz', 'Agnieszka', 'Pawel'];
            return names[Math.floor(Math.random() * names.length)];
        }
        
        function generateDocumentNumber() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const letter1 = letters[Math.floor(Math.random() * letters.length)];
            const letter2 = letters[Math.floor(Math.random() * letters.length)];
            const letter3 = letters[Math.floor(Math.random() * letters.length)];
            const numbers = Math.floor(100000 + Math.random() * 900000);
            return `${letter1}${letter2}${letter3}${numbers}`;
        }

        function createQRModal(qrData, numericCode, firstName, lastName) {
            var existingModal = document.getElementById('qr-modal');
            if (existingModal) {
                existingModal.remove();
                if (existingModal.timerInterval) {
                    clearInterval(existingModal.timerInterval);
                }
            }
            
            var modal = document.createElement('div');
            modal.id = 'qr-modal';
            modal.innerHTML = `
                <div class="modal-header">
                    <button class="modal-close">Zamknij</button>
                </div>
                <div class="modal-content">
                    <h1 style="font-size: 24px; margin-bottom: 15px; color: #333;">Pokaż kod QR</h1>
                    <p style="color: #666; margin-bottom: 30px; max-width: 80%; line-height: 1.4;">
                        Poproś osobę, której sprawdzasz dokument, aby zeskanowała lub przepisała ten kod w swojej aplikacji mObywatel.
                    </p>
                    <div class="qr-code-container" id="qr-code-container">
                        <canvas id="qr-canvas"></canvas>
                    </div>
                    <div class="qr-number">${numericCode}</div>
                    <div class="qr-timer">
                        <div class="progress-bar">
                            <div class="progress" id="qr-progress"></div>
                        </div>
                        <p id="timer-text">Kod wygaśnie za: 3 min 0 sek.</p>
                    </div>
                    <div id="expired-section" style="display: none;">
                        <p class="expired-message">Kod wygasł!</p>
                        <button class="regenerate-btn" id="regenerate-btn">Wygeneruj nowy kod</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Generuj kod QR
            QRCode.toCanvas(document.getElementById('qr-canvas'), qrData, {
                width: 260,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                },
                errorCorrectionLevel: 'M'
            }, function (err) {
                if (err) {
                    console.error(err);
                    document.getElementById('qr-code-container').innerHTML = 
                        '<div style="color: #999; text-align: center;">Błąd generowania kodu QR</div>';
                }
            });
            
            // Timer
            var timeLeft = 180;
            var progressBar = document.getElementById('qr-progress');
            var timerText = document.getElementById('timer-text');
            var expiredSection = document.getElementById('expired-section');
            
            modal.timerInterval = setInterval(function() {
                timeLeft--;
                var progress = (timeLeft / 180);
                progressBar.style.transform = 'scaleX(' + progress + ')';
                
                if (timeLeft <= 0) {
                    clearInterval(modal.timerInterval);
                    timerText.style.display = 'none';
                    expiredSection.style.display = 'block';
                    progressBar.style.backgroundColor = '#ff4444';
                } else {
                    var minutes = Math.floor(timeLeft / 60);
                    var seconds = timeLeft % 60;
                    timerText.textContent = 'Kod wygaśnie za: ' + minutes + ' min ' + seconds + ' sek.';
                }
            }, 1000);
            
            // Zamknięcie modala
            document.querySelector('.modal-close').addEventListener('click', function() {
                if (modal.timerInterval) {
                    clearInterval(modal.timerInterval);
                }
                modal.remove();
            });
            
            // Przycisk do generowania nowego kodu
            document.getElementById('regenerate-btn').addEventListener('click', function() {
                if (modal.timerInterval) {
                    clearInterval(modal.timerInterval);
                }
                modal.remove();
                showQRCode(); // Generuj nowy kod
            });
        }
    </script>
    <script src="assets/manifest.js"></script>
</body>
</html>
